{% load static %}
{% load my_custom_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagine Drive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}">
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <style>

    </style>        
</head>
<body>
   

    <script>
        // Dynamically set the base URL using Django's url template tag
        var baseUrl = "http://127.0.0.1:8000/";  // Adjust 'your_base_view_name'
    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand logo swift-fonts" href="#">
                <img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="MyDrive Logo">
                Imagine Drive
            </a>
            <form class="d-flex mx-auto w-50">
                <input class="form-control me-2" type="search" placeholder="Search in MyDrive" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
             <!-- Diaplyng the short user name with the user details and change password option-->
             <div class="initials-circle dropdown"  style="left: -150px;" >
                {% with user.username|get_short_uname as stname %}
                <a class="rounded-circle" style="color:white;font-size:20px; left: 0px;" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{stname}}</a>
                {% endwith %}
               
                <div class="dropdown-menu swift-fonts"  aria-labelledby="dropdownMenuButton">
                 <a class="dropdown-item" style="font-weight:bold; color:blue;">{{user.username}}</a>
                 <a class="dropdown-item" style="font-weight:bold; color:blue;" >{{user.email}}</a>
                 <a class="dropdown-item" style="font-weight:bold; color: red;" data-bs-toggle="modal" data-bs-target="#ChangePasswordModal">Change Password</a>
                </div>
            </div>
        </div>
    </nav>
 
    <!-- Sidebar and Content -->


    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class=" holding col-md-3 col-lg-1 d-md-block">

                <!-- Showing the username and page name -->
                <div class="fw-bold swift-fonts text-center " style="color:gray">
                    <h4>{{user.username}}</h4>
                    <div></div>
                    <h4 style="color:blue" >Junk Box</h4>
                 </div>
                 <div style="right: 50%;">
                
                </div>
                <div class=" pt-3 px-md-0">
                    <ul class="nav flex-column">
                        <li class="nav-item text-center"style="padding: 10px">
                         
                            <a class=" btn btn-primary swift-fonts dropdown-toggle" data-bs-toggle="collapse" href="#collapseExample" role="button" 
                            aria-expanded="false" aria-controls="collapseExample" style ="width: 100%" >Tools</a>
                        </li>
                        <li class="nav-item collapse"style="padding: 10px" id="collapseExample" >
                           
                            <a class="btn btn-secondary swift-fonts " href="{% url 'index' %}" style ="width: 100%" >
                                <i class='fas fa-folder-open' style='font-size:24px'></i>
                               My Files
                            </a>
                        </li>
                        <li class="nav-item collapse" style="padding: 10px" id="collapseExample">
                            <a class="btn btn-secondary swift-fonts" href="{% url 'display_sharing' %}" style ="width: 100%">
                                <i class='fas fa-share-square' style='font-size:24px'></i>
                             Share Box
                            </a>
                        </li>
                        
                        <li class="nav-item collapse"style="padding: 10px" id="collapseExample">
                            <a class="btn btn-secondary  swift-fonts" href="#" style ="width: 100%">
                                <i class='fas fa-trash-alt' style='font-size:24px'></i>
                                Junk Box 
                            </a>
                            
                        </li>
                    </ul>
                </div>
            </nav>
             
            <!-- The Toolbar just beneth of the searching portion -->

            <main class="col-md-2  col-lg-10 px-md-5 ">
                <div class="toolbar my-4" style="padding: 10px;">
               
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                            ‚ûï New
                        </button>

            <!-- Dropdown menu for the folde create and file upload-->

                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#newFolderModal">üìÇ New Folder</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#uploadModal">‚¨ÜÔ∏è Upload Files</a></li>
                            
                        </ul>
                    </div>
                    <div class="d-flex-align-items-center">
                        <a >
                            <button class="btn btn-outline-secondary " type="button" aria-expanded="false" disabled>‚¨ÖÔ∏è Back</button>
                        </a>
    				</div>
                    
                    <div class="beside-back ms-sm-auto">
                        {% if user.is_authenticated %}
                        <a href="{% url 'logout' %}">
        				<button class="btn btn-outline-secondary me-2" style="font-size: 13px;">‚¨ÖÔ∏è Logout</button>
                        </a>
                        {% endif %}
    				</div>
                </div>


             <!-- Message display related  -->

                {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              
              {% endif %}

            <!-- Main Content -->
                <div class="table-responsive mt-2 ">
                    <table class="table table-hover">
                        <thead class="thead-light swift-fonts">
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">File Size</th>
                                <th scope="col">Deleted Date</th>
                                <th scope="col">Deleted By</th>
                                <th scope="col">Original Location</th>
                            </tr>
                        </thead>
                        {% load my_custom_tags %}
                          
                        <tbody >
                            <!-- For the Deleted file objects dispaly related -->
                            {% for f in trash %}
                            <tr>
                                <td>
                                    
                                    <div class="item file-card dropdown" data-id="{{f.t_id}}" >
                                        
                                       {% with f.name|file_extension as ext %}
                                            {% if ext == 'pdf' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/pdf-2--v1.png" alt="pdf-2--v1"/>
                                            {% elif ext == 'doc' or ext == 'docx' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/word.png" alt="word"/>
                                            {% elif ext == 'xls' or ext == 'xlsx' %}
                                                <img width="35" height="35" src="https://img.icons8.com/color/48/xls.png" alt="xls"/>
                                            {% elif ext == 'jpg' or ext == 'png' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/full-image.png" alt="full-image"/>
                                            {% elif ext == 'txt' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/txt.png" alt="txt"/>
                                            {% elif ext == 'ppt' or ext == 'pptx' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/powerpoint.png" alt="powerpoint"/>
                                            {% elif ext == 'exe' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/exe.png" alt="exe"/>
                                            {% elif ext == 'txt' %}
                                               <img width="35" height="35" src="https://img.icons8.com/color/48/txt.png" alt="txt"/>
                                            {% elif ext == 'zip' or ext == 'rar'%}
                                              <img width="35" height="35" src="https://img.icons8.com/fluency/48/archive.png" alt="archive"/>
                                            {% elif ext == 'mp4' or ext == 'avi' or ext == 'mov' or ext == 'wmv' or ext == 'mkv'  or  ext == 'webm' %}
                                              <img width="35" height="35"src="https://img.icons8.com/ios-filled/50/video-file.png" alt="video-file"/>
                                            {% elif ext == 'None' or ext == '' %}
                                              <img width="30" height="30" src="https://img.icons8.com/3d-fluency/94/folder-invoices--v2.png" alt="folder-invoices--v2"/>
                                            {% else %}
                                              <img width="35" height="35"  src="https://img.icons8.com/color/48/file.png" alt="file"/>    
                                            {% endif %}
                                      {% endwith %} 
                                            <a >{{ f.name }}</a>
                                            <ul class="dropdown-menu">
                                    
                                <!-- Right Click Featues for the files and folders Depending on does the previous parent folder is available or not -->
  
                                                {% with  f.prt_id|path_list  as list%}
                                                {% if list == 'None' %}
                                                <li><a class="dropdown-item"  data-bs-toggle="modal" data-bs-target="#MoveModel">Move</a></li>
                                                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#DeleteModel">Delete</a></li>
                                                {% else %}
                                                <li><a class="dropdown-item" href="{%url 'restore' f.t_id %}" method ='post' >Restore</a></li>
                                                <li><a class="dropdown-item"  data-bs-toggle="modal" data-bs-target="#MoveModel">Move</a></li>
                                                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#DeleteModel">Delete</a></li>
                                                {% endif %}
                                                {% endwith %}
                                                
                                    
                                            </ul>
                                    </div>
                                </td>
                                <td>{% if f.data_type == 'file' %}
                                     {% with list=f.t_id|get_obj_inst %}
                                      {{ list.file.size|filesize_in_kb }}
                                      {% endwith %}
                                    {% elif f.data_type == 'folder' %}
                                      {{ f.t_id|item_counts }} items
                                    {% endif %}
                                </td>
                                <td>{{ f.dlt_at|date:"Y-m-d H:i" }}</td>
                                <td> @{{ f.dlt_by }}</td>
                                <td>{{ f.prt_id|path_list }}</td>
                                
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </main>
        </div>
    </div>
    
     <!--deletion confermation Label-->

     <div class="modal fade" id="DeleteModel" tabindex="-1" aria-labelledby="DeleteModelLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="DeleteModellLabel">Delete Objects</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="delete-Form" action ="{% url 'delete_trash' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <p>Are you sure you want to delete ? </p>
                            <input type="hidden" id="object_Id" name="object_id" value="">
    
                        </div>
                        <button type="submit"class="btn btn-primary">Confirm</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
        <!-- Move the object into a folder -->
<div class="modal fade" id="MoveModel" tabindex="-1" aria-labelledby="MoveModelLabel" aria-hidden="true">
    <div class="modal-dialog " style="max-width: 70%; height: 800px;  width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="MoveModelLabel">Move Objects</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div>
                <div class="toolbar my-4" style="padding: 10px;">
                    <div class="d-flex-align-items-center">
                        <form action="{% url 'trash_display_with_move' %}" method="get">
                            <button class="btn btn-outline-secondary me-2" style="font-size: 13px; font-width: bold;">‚¨ÖÔ∏è Cencel
                            </button>
                        </form>

                    </div>
                    <div class="d-flex-align-items-center">
                        <form action="{% url 'path_change_back' parent_name %}" method="get">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" disabled>‚¨ÖÔ∏è Back</button>
                        </form>
                    </div>
            </div>
            <div class="modal-body" id="folderContent" >
                <form id="MoveForm" action="{% url 'path_change' parent_id %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="container mt-4">
                        <div class="table-responsive mt-2">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th scope="col">Name</th>
                                        <th scope="col">Created</th>
                                        <th scope="col">Modified</th>
                                        <th scope="col">Shared With</th>
                                    </tr>
                                </thead>
                                <tbody id="folderList">
                                    {% for fd in folders %}
                                    <tr>
                                        <td ><div data-id="{{f.data_id}}" data-type="{{f.data_type}}">
                                            <div class="file-card">
                                                <img width="30" height="30" src="https://img.icons8.com/3d-fluency/94/folder-invoices--v2.png" alt="folder-invoices"/>
                                                {{ fd.name }}
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" onclick="openFolder('{{ fd.data_id}}','{{ fd.name }}')">open</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                        <td>{{ fd.created_at|date:"Y-m-d H:i" }}</td>
                                        <td>{{ fd.updated_at|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            {% for user in fd.shared_with.all %}
                                                {{ user.username }}{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                Not shared
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tbody>
                                    <button type="submit" class="btn btn-primary">Move</button>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mb-3">
                    <input type="hidden"  id="object_id" name="object_id" value="">
                    <div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- HTML for the Modal -->



    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/unrar-js@0.2.3/unrar.min.js"></script>

    <script>
        // Function to handle right-click and dropdown behavior
        document.querySelectorAll('.file-card').forEach(card => {
            card.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                document.querySelectorAll('.file-card').forEach(c => c.classList.remove('show-menu'));
                this.classList.add('show-menu');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.file-card')) {
                document.querySelectorAll('.file-card').forEach(c => c.classList.remove('show-menu'));
            }
        });

/////////////// used for move form to fill up the hidden inputs  /////////////////////////////// 

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('MoveForm');
            const itemIdInput = document.getElementById('object_id');
            const selectedObjectId = localStorage.getItem('selectedObjectId'); // or URL parameter
            if (selectedObjectId) {
                itemIdInput.value = selectedObjectId;
                console.log(selectedObjectId);
            }
        });
//////////////// Used for Delete Form  to fill up the hidden inputs ////////////////////////////

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('delete-Form');
            const itemIdInput = document.getElementById('object_Id');
        
            document.querySelectorAll('.item').forEach(item => {
                item.addEventListener('contextmenu', function(event) {
                    event.preventDefault(); // Prevent the default context menu
        
                    // Get item ID and type
                    const itemId = this.getAttribute('data-id');
                    // Ensure 'data-type' is set for each item
                
                    // Set the hidden fields in the form
                    itemIdInput.value = itemId;
                   
        
                    /// Set the form action URL based on item type
                    
                    //form.action = '/rename/'; // URL for folder rename
                  
        
                    // Show the form/modal (adjust based on your modal implementation)
                    // Example: Use Bootstrap modal
                    $('#deleteModal').modal('show');///
                });
            });
        });



    ////////////////////////   For setting up the localStorage as "selectObjectId"  for getting the right click objects dataid////////////////////////////

        document.querySelectorAll('.item').forEach(item => {
            item.addEventListener('contextmenu', function(event) {
                event.preventDefault(); // Prevent the default context menu
    
                // Get item ID and type
                const itemId = this.getAttribute('data-id');
                console.log(itemId);
                 // Ensure 'data-type' is set for each item
            
                // Set the hidden fields in the form
                
                localStorage.setItem('selectedObjectId', itemId);
    
                /// Set the form action URL based on item type
                
                //form.action = '/rename/'; // URL for folder rename
              
    
                // Show the form/modal (adjust based on your modal implementation)
                // Example: Use Bootstrap modal
            });
        });


    ///////// for rename function use input find and calling the function////////////////////////////////////////////

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('renameForm');
            const itemIdInput = document.getElementById('object_id');
            const selectedObjectId = localStorage.getItem('selectedObjectId'); // or URL parameter
            if (selectedObjectId) {
                itemIdInput.value = selectedObjectId;
            }
        });


    ///////////////////////////// Displaying the folder contents in the Move function in a popup window ////////////////////////////

        function openFolder(folderId) {
            // Perform an AJAX request to get folder details
            const url = baseUrl + 'trash_display_with_move/' + encodeURIComponent(folderId);
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.text())  // Expect HTML content as the response
            .then(data => {
                // Update modal content with the new folder structure (the response from Django)
                document.getElementById('folderContent').innerHTML = data;
        
                // Update the hidden input with the object ID
                const selectedObjectId = localStorage.getItem('selectedObjectId'); // Get from localStorage
                const itemIdInput = document.getElementById('object_id');
                if (selectedObjectId) {
                    itemIdInput.value = selectedObjectId; // Set the hidden input
                    console.log('Setting object_id to on trash:', selectedObjectId);
                }
        
                // Reattach the event listeners for the new content
                attachEventListeners();
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Function to attach context menu event listeners
        function attachEventListeners() {
            document.querySelectorAll('.file-card').forEach(card => {
                card.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    const objectId = this.getAttribute('data-id'); // Assuming the ID is stored in 'data-id'
        
           
        
                    // Show the context menu
                    document.querySelectorAll('.file-card').forEach(c => c.classList.remove('show-menu'));
                    this.classList.add('show-menu');
                });
            });
        
            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.file-card')) {
                    document.querySelectorAll('.file-card').forEach(c => c.classList.remove('show-menu'));
                }
            });
        }
        
        // Set the object_id when the modal is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const itemIdInput = document.getElementById('object_id');
            const selectedObjectId = localStorage.getItem('selectedObjectId'); // Get the ID from localStorage
        
            // Set the value of the hidden input if selectedObjectId exists
            if (selectedObjectId) {
                itemIdInput.value = selectedObjectId;
                console.log('Setting object_id to Trash:', selectedObjectId);
            }
        });
        
    </script>
  
  </body>
</html>
